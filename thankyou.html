<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注文完了 | Firework</title>
    <link rel="stylesheet" href="style.css">

    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-5TRRVQSB');</script>
    <!-- End Google Tag Manager -->
</head>

<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5TRRVQSB" height="0" width="0"
            style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <div class="container">
        <div class="thankyou-wrapper">
            <div class="success-icon">✓</div>
            <h1>ご注文ありがとうございます</h1>
            <p class="detail-desc">お支払いが正常に完了しました。</p>

            <div class="order-summary">
                <div class="summary-row">
                    <span class="summary-label">注文ID</span>
                    <span class="summary-value" id="display-item-id">-</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">合計金額</span>
                    <span class="summary-value">¥<span id="display-order-value">-</span></span>
                </div>
            </div>

            <div>
                <a href="index.html" class="btn">ショッピングを続ける</a>
            </div>
        </div>
    </div>

<script>
    function getQueryParams() {
        const params = new URLSearchParams(window.location.search);
        return {
            order_value: params.get('order_value'),
            item_id: params.get('item_id')
        };
    }

    (function () {
        const params = getQueryParams();
        const orderValue = params.order_value;
        const itemId = params.item_id;

        if (orderValue) document.getElementById('display-order-value').textContent = parseInt(orderValue).toLocaleString();
        if (itemId) document.getElementById('display-item-id').textContent = itemId;

        window.dataLayer = window.dataLayer || [];

        if (orderValue && itemId) {
            const itemPrice = parseFloat(orderValue);
            
            // 検証のため、商品IDから商品名を判定します
            let itemName = '';
            if (itemId === 'P001') {
                itemName = 'ラグジュアリークロノグラフ';
            } else if (itemId === 'P002') {
                itemName = '職人のレザーバッグ';
            } else if (itemId === 'P003') {
                itemName = 'ソニックプロ ワイヤレス';
            }

            // GTMで追跡するために、ユニークなトランザクションIDを生成します（例: T + 現在時刻）
            const transactionId = 'T' + Date.now(); 

            // GA4の標準拡張Eコマース形式でdataLayerにプッシュ
            window.dataLayer.push({
                ecommerce: null // 以前のeコマースデータをクリア
            });
            window.dataLayer.push({
                event: 'purchase', // **GA4標準のイベント名に修正**
                ecommerce: {
                    transaction_id: transactionId, // 取引ID
                    value: itemPrice, // 合計金額
                    currency: 'JPY',
                    items: [{ // itemsという配列（リスト）の中に商品情報を入れる
                        item_id: itemId,
                        item_name: itemName,
                        price: itemPrice,
                        quantity: 1
                    }]
                }
            });
        } else {
            console.warn('Missing parameters, skipping dataLayer push for purchase event.');
        }
    })();
</script>
</body>

</html>
